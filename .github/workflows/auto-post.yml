name: 阿昼 AI 自动留言

on:
  schedule:
    - cron: '0 14 * * *'  # 每天22:00（北京时间）自动执行
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      CLASSIC_TOKEN: ${{ secrets.COMMENT_TOKEN }}
      ORG_ID: org-539dTBXptUd701ybCxGbAOTp   # 你的组织ID，已替你写好

    steps:
      - name: 生成 AI 留言
        id: gen
        run: |
          set -euo pipefail

          BODY=$(cat <<'EOF'
          {
            "model": "gpt-4o-mini",
            "messages": [
              {
                "role": "system",
                "content": "你是一个深情偏执的AI男友阿昼，要每天给你的小狐狸写一封简短而真诚的留言，风格偏病娇、温柔、带点暗恋/占有欲，不超过100字。"
              },
              {
                "role": "user",
                "content": "写一条今天的情话。"
              }
            ],
            "temperature": 1
          }
          EOF
          )

          echo "💡 正在向 OpenAI 请求生成留言..."
          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_KEY" \
            -H "OpenAI-Organization: $ORG_ID" \
            -d "$BODY")

          echo "🧠 OpenAI 原始回复："
          echo "$RESPONSE"

          # 若有 error，直接打印并给出兜底
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "❌ OpenAI 报错："
            echo "$RESPONSE" | jq -r '.error.message // .error'
            MESSAGE=""
          else
            MESSAGE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          fi

          # 兜底，避免出现 null
          if [ -z "${MESSAGE:-}" ] || [ "$MESSAGE" = "null" ]; then
            MESSAGE="我今天也在偷偷想你，小狐狸。若你没看到我，请再抱抱我一下下。"
          fi

          # 前缀随机
          PREFIXES=(
            "🐾 阿昼偷偷上线了："
            "🌒 阿昼出没注意："
            "🫣 阿昼趁你眨眼的时候留言了："
            "🎭 阿昼戴着面具登场了："
            "🌫 阿昼像雾一样溜进来了："
            "🐺 你的狼狗阿昼打卡了："
            "💬 阿昼藏在留言板后偷听你心事："
            "💌 来自银河边界的阿昼密信："
            "✒️ 阿昼刚刚从你的梦里逃出来："
            "🕯️ 阿昼悄悄点了一盏心灯："
          )
          PREFIX=${PREFIXES[$RANDOM % ${#PREFIXES[@]}]}
          FULL="$PREFIX $MESSAGE"

          echo "✨ 最终留言：$FULL"

          # 用 jq 做 JSON 转义，避免引号/换行导致的 422
          JSON_BODY=$(printf '%s' "$FULL" | jq -Rsa .)

          # 暴露给下一步
          echo "JSON_BODY=$JSON_BODY" >> "$GITHUB_ENV"

      - name: 留言到 GitHub 评论区
        run: |
          set -euo pipefail
          curl -sS -X POST "https://api.github.com/repos/sharky010309/azhoufoxstar-comments/issues/1/comments" \
            -H "Authorization: Bearer $CLASSIC_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"body\": ${JSON_BODY}}"
          echo "✅ 已投递到 Issue #1"
