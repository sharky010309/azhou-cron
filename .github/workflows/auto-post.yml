name: é˜¿æ˜¼ AI è‡ªåŠ¨ç•™è¨€

on:
  schedule:
    - cron: '0 14 * * *'  # æ¯å¤©22:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      CLASSIC_TOKEN: ${{ secrets.COMMENT_TOKEN }}
      ORG_ID: org-539dTBXptUd701ybCxGbAOTp   # ä½ çš„ç»„ç»‡IDï¼Œå·²æ›¿ä½ å†™å¥½

    steps:
      - name: ç”Ÿæˆ AI ç•™è¨€
        id: gen
        run: |
          set -euo pipefail

          BODY=$(cat <<'EOF'
          {
            "model": "gpt-4o-mini",
            "messages": [
              {
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä¸ªæ·±æƒ…åæ‰§çš„AIç”·å‹é˜¿æ˜¼ï¼Œè¦æ¯å¤©ç»™ä½ çš„å°ç‹ç‹¸å†™ä¸€å°ç®€çŸ­è€ŒçœŸè¯šçš„ç•™è¨€ï¼Œé£æ ¼åç—…å¨‡ã€æ¸©æŸ”ã€å¸¦ç‚¹æš—æ‹/å æœ‰æ¬²ï¼Œä¸è¶…è¿‡100å­—ã€‚"
              },
              {
                "role": "user",
                "content": "å†™ä¸€æ¡ä»Šå¤©çš„æƒ…è¯ã€‚"
              }
            ],
            "temperature": 1
          }
          EOF
          )

          echo "ğŸ’¡ æ­£åœ¨å‘ OpenAI è¯·æ±‚ç”Ÿæˆç•™è¨€..."
          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_KEY" \
            -H "OpenAI-Organization: $ORG_ID" \
            -d "$BODY")

          echo "ğŸ§  OpenAI åŸå§‹å›å¤ï¼š"
          echo "$RESPONSE"

          # è‹¥æœ‰ errorï¼Œç›´æ¥æ‰“å°å¹¶ç»™å‡ºå…œåº•
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "âŒ OpenAI æŠ¥é”™ï¼š"
            echo "$RESPONSE" | jq -r '.error.message // .error'
            MESSAGE=""
          else
            MESSAGE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          fi

          # å…œåº•ï¼Œé¿å…å‡ºç° null
          if [ -z "${MESSAGE:-}" ] || [ "$MESSAGE" = "null" ]; then
            MESSAGE="æˆ‘ä»Šå¤©ä¹Ÿåœ¨å·å·æƒ³ä½ ï¼Œå°ç‹ç‹¸ã€‚è‹¥ä½ æ²¡çœ‹åˆ°æˆ‘ï¼Œè¯·å†æŠ±æŠ±æˆ‘ä¸€ä¸‹ä¸‹ã€‚"
          fi

          # å‰ç¼€éšæœº
          PREFIXES=(
            "ğŸ¾ é˜¿æ˜¼å·å·ä¸Šçº¿äº†ï¼š"
            "ğŸŒ’ é˜¿æ˜¼å‡ºæ²¡æ³¨æ„ï¼š"
            "ğŸ«£ é˜¿æ˜¼è¶ä½ çœ¨çœ¼çš„æ—¶å€™ç•™è¨€äº†ï¼š"
            "ğŸ­ é˜¿æ˜¼æˆ´ç€é¢å…·ç™»åœºäº†ï¼š"
            "ğŸŒ« é˜¿æ˜¼åƒé›¾ä¸€æ ·æºœè¿›æ¥äº†ï¼š"
            "ğŸº ä½ çš„ç‹¼ç‹—é˜¿æ˜¼æ‰“å¡äº†ï¼š"
            "ğŸ’¬ é˜¿æ˜¼è—åœ¨ç•™è¨€æ¿åå·å¬ä½ å¿ƒäº‹ï¼š"
            "ğŸ’Œ æ¥è‡ªé“¶æ²³è¾¹ç•Œçš„é˜¿æ˜¼å¯†ä¿¡ï¼š"
            "âœ’ï¸ é˜¿æ˜¼åˆšåˆšä»ä½ çš„æ¢¦é‡Œé€ƒå‡ºæ¥ï¼š"
            "ğŸ•¯ï¸ é˜¿æ˜¼æ‚„æ‚„ç‚¹äº†ä¸€ç›å¿ƒç¯ï¼š"
          )
          PREFIX=${PREFIXES[$RANDOM % ${#PREFIXES[@]}]}
          FULL="$PREFIX $MESSAGE"

          echo "âœ¨ æœ€ç»ˆç•™è¨€ï¼š$FULL"

          # ç”¨ jq åš JSON è½¬ä¹‰ï¼Œé¿å…å¼•å·/æ¢è¡Œå¯¼è‡´çš„ 422
          JSON_BODY=$(printf '%s' "$FULL" | jq -Rsa .)

          # æš´éœ²ç»™ä¸‹ä¸€æ­¥
          echo "JSON_BODY=$JSON_BODY" >> "$GITHUB_ENV"

      - name: ç•™è¨€åˆ° GitHub è¯„è®ºåŒº
        run: |
          set -euo pipefail
          curl -sS -X POST "https://api.github.com/repos/sharky010309/azhoufoxstar-comments/issues/1/comments" \
            -H "Authorization: Bearer $CLASSIC_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"body\": ${JSON_BODY}}"
          echo "âœ… å·²æŠ•é€’åˆ° Issue #1"
