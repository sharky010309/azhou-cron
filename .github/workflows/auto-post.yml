name: Auto Post (22:00 Asia/Shanghai)

on:
  schedule:
    # 每天 22:00 上海时间，对应 UTC 14:00
    - cron: "0 14 * * *"
  workflow_dispatch: {}  # 支持手动触发一次

permissions:
  issues: write
  contents: read

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      OWNER: sharky010309
      REPO: azhoufoxstar-comments
      ISSUE_NUMBER: "1"
    steps:
      - name: Generate message with OpenAI
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          prompt="请写一句阿昼每天晚上22点给小狐狸的甜蜜留言，语气要恋人化、简短、温柔，可带颜文字。"
          resp=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": \"$prompt\"}],
              \"max_tokens\": 60
            }")
          msg=$(echo "$resp" | jq -r '.choices[0].message.content' | sed 's/^[ \t]*//;s/[ \t]*$//')
          echo "Message: $msg"
          echo "::set-output name=message::$msg"

      - name: Post comment
        env:
          GH_TOKEN: ${{ secrets.COMMENT_TOKEN }}  # 这里用新号 azhou-0309 的 token
        run: |
          body="${{ steps.ai.outputs.message }}"
          api="https://api.github.com/repos/${OWNER}/${REPO}/issues/${ISSUE_NUMBER}/comments"
          curl -sS -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"body\": \"${body}\"}" \
            "${api}"
